# Схема подключения Auto-dor

Управление откатными воротами Alutech RTO-500
Плата: ESP32-DevKitC V2 (ESP32-WROOM-32 / NodeMCU-32S 38pin)

---

## Общая схема

```
                         ┌─────────────────────┐
                         │    ESP32-DevKitC V2  │
                         │     (38 pin)         │
                         │                      │
                   3V3 ──┤ 3V3            VIN ├── 5В от БП
                         │                      │
    Реле 1 (IN) ◄────────┤ GPIO 26    GPIO 27 ├────────► Реле 2 (IN)
    (открытие)           │                      │         (закрытие)
                         │                      │
    LED открытия ◄───────┤ GPIO 25    GPIO 13 ├───────► LED закрытия
                         │                      │
    Кнопка "Открыть" ───►┤ GPIO 14    GPIO 12 ├◄─── Кнопка "Закрыть"
                         │                      │
    Концевик ОТКРЫТО ───►┤ GPIO 32    GPIO 33 ├◄─── Концевик ЗАКРЫТО
                         │                      │
                   GND ──┤ GND            GND ├── GND
                         └─────────────────────┘
```

---

## Реле (30А, active LOW)

```
                    Модуль Реле 1 (ОТКРЫТИЕ)
                    ┌──────────────────────┐
    ESP32 VIN (5В) ─┤ DC+    ┌────┐   COM ├─── Фаза (от автомата)
    ESP32 GND ──────┤ DC-    │реле│    NO ├─── К обмотке 1 мотора
    ESP32 GPIO 26 ──┤ IN     └────┘    NC ├─── (не подключен)
                    └──────────────────────┘
                           │        │
                     RC-снаббер (параллельно COM-NO)

                    Модуль Реле 2 (ЗАКРЫТИЕ)
                    ┌──────────────────────┐
    ESP32 VIN (5В) ─┤ DC+    ┌────┐   COM ├─── Фаза (от автомата)
    ESP32 GND ──────┤ DC-    │реле│    NO ├─── К обмотке 2 мотора
    ESP32 GPIO 27 ──┤ IN     └────┘    NC ├─── (не подключен)
                    └──────────────────────┘
                           │        │
                     RC-снаббер (параллельно COM-NO)
```

---

## Тактовая кнопка (4 ножки)

Стандартная тактовая кнопка имеет 4 ножки. Внутри они соединены попарно:

```
        Вид сверху (кнопка лежит на столе)
        ─────────────────────────────────

              ┌───────────┐
              │           │
         1 ───┤   ┌───┐   ├─── 2
              │   │BTN│   │
         3 ───┤   └───┘   ├─── 4
              │           │
              └───────────┘

        Внутренние соединения:
        ─────────────────────
        Ножки 1 и 2 — ВСЕГДА соединены (одна шина)
        Ножки 3 и 4 — ВСЕГДА соединены (вторая шина)

        При нажатии кнопки шины замыкаются:
        1-2 ──── соединяются с ──── 3-4
```

**Как определить какие ножки соединены:**
- Поверни кнопку — ножки расположены по бокам (по 2 с каждой стороны)
- Ножки на ОДНОЙ СТОРОНЕ = всегда соединены
- Ножки на РАЗНЫХ сторонах = соединяются при нажатии
- Если есть мультиметр — поставь на прозвонку и проверь

**Правильное подключение к ESP32:**

```
    Кнопка "Открыть"                  Кнопка "Закрыть"

    GPIO 14                           GPIO 12
      │                                 │
      ├─── ножка 1 (или 2)             ├─── ножка 1 (или 2)
      │    ┌───────────┐               │    ┌───────────┐
      │    │           │               │    │           │
      └────┤   кнопка  │               └────┤   кнопка  │
           │           │                    │           │
      ┌────┤           │               ┌────┤           │
      │    └───────────┘               │    └───────────┘
      │                                │
      └─── ножка 3 (или 4)            └─── ножка 3 (или 4)
      │                                │
     GND                              GND
```

**Важно:** подключаем к ножкам с РАЗНЫХ сторон кнопки (1 и 3, или 1 и 4, или 2 и 3, или 2 и 4). Если подключить к ножкам одной стороны (1 и 2, или 3 и 4) — будет постоянное замыкание, кнопка не будет работать.

**На макетной плате (breadboard):**

```
    Макетная плата           Правильно         Неправильно
    ┌──────────────┐
    │  a b c d e   │         GPIO ─► a1        GPIO ─► a1
    │  · · · · ·  1│                            (ножки 1-2 на
    │  · · · · ·  2│         GND ──► a2         одной линии =
    │  · · · · ·   │         (ножки 1 и 3       всегда замкнуто)
    │  · · · · ·   │          на разных
    │  f g h i j   │          линиях)
    └──────────────┘
```

Кнопка ставится ПОПЕРЁК канавки на макетной плате — тогда ножки с разных сторон гарантированно на разных шинах.

---

## Концевики

```
    Концевик "ОТКРЫТО"          Концевик "ЗАКРЫТО"

    GPIO 32 ──┐                 GPIO 33 ──┐
              │/│                          │/│
    GND ──────┘                 GND ──────┘

    Тип: нормально замкнутые (NC)
    INPUT_PULLUP внутри ESP32.

    Обычное состояние (ворота НЕ в крайнем положении):
        контакт замкнут → пин = LOW (через замкнутый контакт на GND)

    Сработал (ворота достигли крайнего положения):
        контакт разомкнут → пин = HIGH (подтяжка INPUT_PULLUP)

    Преимущество NC: если провод оборвётся, пин = HIGH =
    = "концевик сработал" → мотор остановится (безопаснее).
```

---

## Светодиоды

```
    GPIO 25 ──── [R 220 Ом] ────  [LED] ──── GND
                                (открытие)

    GPIO 13 ──── [R 220 Ом] ────  [LED] ──── GND
                                (закрытие)

    Резистор 220 Ом ОБЯЗАТЕЛЕН! (ESP32 даёт 3.3В)
    Без резистора LED сгорит.
    Длинная ножка LED (+) к резистору, короткая (-) к GND.
```

---

## Силовая часть 230В

```
                  ┌──────────────┐
    230В ФАЗА ────┤ Автомат 6А   ├────┬───► Реле 1 COM
                  │ IEK ARMAT    │    │
                  │ M06N C6      │    └───► Реле 2 COM
                  └──────────────┘

    Реле 1 NO ──────► Обмотка 1 мотора (открытие) ──┐
                                                     ├── Общий мотора
    Реле 2 NO ──────► Обмотка 2 мотора (закрытие) ──┘
                                                     │
    230В НОЛЬ ───────────────────────────────────────┘

    RC-снабберы RC125-1000 — параллельно COM-NO каждого реле.
```

**!!! НИКОГДА оба реле одновременно — КЗ и сгоревший мотор !!!**

---

## Питание

```
    230В ──► [Блок питания 5В] ──┬──► ESP32 VIN (5В)
                                 ├──► Реле 1 DC+ (5В)
                                 └──► Реле 2 DC+ (5В)

    БП GND ──────────────────────┬──► ESP32 GND
                                 ├──► Реле 1 DC-
                                 └──► Реле 2 DC-
```

Все GND (ESP32, реле, кнопки, концевики, LED) — соединены в одну точку.

---

## Веб-интерфейс (управление с телефона)

ESP32 поднимает HTTP-сервер на порту 80. Для доступа телефон должен быть в той же Wi-Fi сети.

### Настройка

В файле `Auto-dor.ino` перед заливкой заполнить:

```cpp
#define WIFI_SSID     "имя_сети"
#define WIFI_PASSWORD "пароль_сети"

#define WEB_LOGIN     "логин"     // логин веб-интерфейса
#define WEB_PASS      "пароль"    // пароль веб-интерфейса
```

### Статический IP

По умолчанию настроен статический IP. Параметры задаются в начале файла:

```cpp
IPAddress staticIP(192, 168, 1, 50);   // IP адрес ESP32
IPAddress gateway(192, 168, 1, 1);     // Шлюз (IP роутера)
IPAddress subnet(255, 255, 255, 0);    // Маска подсети
IPAddress dns(8, 8, 8, 8);            // DNS
```

Подставь IP шлюза из настроек Wi-Fi на телефоне (обычно `192.168.1.1` или `192.168.0.1`). Число в `staticIP` (последний октет) выбирай в диапазоне 50–250, чтобы не конфликтовал с DHCP.

### Подключение

1. Залить прошивку на ESP32
2. Открыть Serial Monitor (115200 бод) — убедиться, что Wi-Fi подключён и IP отображается
3. На телефоне открыть браузер и ввести IP, например: `http://192.168.1.50`
4. Ввести логин и пароль веб-интерфейса

### Веб-страница

Страница содержит три кнопки:

- **ОТКРЫТЬ** — начать открытие ворот (при движении — стоп)
- **СТОП** — остановить мотор
- **ЗАКРЫТЬ** — начать закрытие ворот (при движении — стоп)

Статус ворот обновляется автоматически каждые 2 секунды.

### API

| Метод | Путь | Описание | Авторизация |
|-------|------|----------|-------------|
| GET | `/` | Главная страница с кнопками | да |
| GET | `/status` | JSON-статус ворот | нет |
| GET | `/action?cmd=open` | Команда «Открыть» | да |
| GET | `/action?cmd=close` | Команда «Закрыть» | да |
| GET | `/action?cmd=stop` | Команда «Стоп» | да |

**GET /status** — ответ:

```json
{
  "state": "idle",
  "stateRus": "Стоят"
}
```

Возможные значения `state`: `idle`, `opening`, `closing`.

**GET /action** — ответ:

```json
{
  "result": "ok",
  "state": "opening",
  "stateRus": "Открываются..."
}
```

Возможные значения `result`: `ok`, `stopped`, `blocked`, `unknown`.
